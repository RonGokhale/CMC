#!/bin/bash
# Written by lithid (mrlithid@gmail.com)
MH="$PIKNAC_HOME/plugins/Lithid-Odex"
H="$PIKNAC_HOME/plugins/Lithid-Odex/.ODEX"
CODE="sh /sdcard/odex"
CMD="adb shell"
DW="dexopt-wrapper"
OS="odex"
AP="system/app"
FW="system/framework"
DA="data/app"
FL="$AP $FW $DA"

if [ "$chk_adb" != "1" ]; then
	clear
	echo "adb isn't running we can't do this. Going to the main menu."
	sleep 1
	$MAIN
fi

cd $MH

for x in $FL; do
if [ ! -d $H/$x ]; then
	mkdir -p $H/$x
fi
done

function del_dex() {
ZIPS=$(find $H -type f -iname *.jar && find $H -type f -name *.apk)
for i in $ZIPS; do
	zip -d $i classes.dex
done
}

function push_files() {
adb remount
adb push $MH/t/$DW /system/bin/$DW
adb shell chmod 0755 /system/bin/$DW
adb push $MH/s/$OS /sdcard/$OS
adb shell chmod 0755 /sdcard/$OS
}

function pull_files() {
cd $H/$AP/
adb pull /$AP/
cd $H/$FW
adb pull /$FW/
cd $H/$DA/
adb pull /$DA/
cd $H
}

function push_finished_files() {
adb remount
adb push $H/$AP /$AP
adb push $H/$FW /$FW
adb push $H/$DA /$DA
}

function clean_up() {
if [ -d $H ]; then
	rm -rf $H/$AP/*
	rm -rf $H/$FW/*
	rm -rf $H/$DA/*
fi
}

# Process it all
export FUNCTIONX="  __Odexing__________________________________________   "
$PIKNAC_FUNCTIONS/loading &
MYSELF=$!
clean_up &>> /dev/null
push_files &>> /dev/null
$CMD $CODE &>> /dev/null
pull_files &>> /dev/null
del_dex &>> /dev/null
push_finished_files &>> /dev/null
kill -9 $MYSELF &>> /dev/null

clear
echo "Odexing is complete!"
echo -e "I have kept the odex files locally for your pleasure! "$CLR">"$toff" $H "$CLR"<"$toff" enjoy!"
sleep 5

$MAIN
